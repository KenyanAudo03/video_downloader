{% extends "base.html" %}
{% block title %}VideoFlow - Media Grabber{% endblock %}
{% block content %}
<div class="main-container">
  <form id="videoForm">
    <div class="form-group">
      <label for="videoUrl">üîó Enter Video URL</label>
      <input
        type="url"
        id="grabberVideoUrl"
        placeholder="Paste TikTok, Instagram, Twitter, Facebook, or YouTube video link here..."
        required
      />
    </div>

    <button type="submit" class="submit-button" id="extractBtn">
      <span>üé¨ Extract Video Information</span>
    </button>
  </form>

  <div class="loading-container" id="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-message">Processing video... Please wait</div>
  </div>

  <div class="results-container" id="result" style="display: none;">
    <div class="video-preview">
      <img id="thumbnail" class="video-thumbnail" alt="Video thumbnail" />
      <div class="video-details">
        <div id="title" class="video-title"></div>
        <div id="platform" class="video-platform"></div>
        <div id="duration" class="video-duration"></div>
      </div>
    </div>

    <div class="download-area">
      <div class="filename-info">üìÅ Download Filename:</div>
      <div class="filename-text" id="filenameDisplay"></div>

      <div class="download-buttons">
        <button
          type="button"
          class="download-button primary-download"
          id="downloadBtn"
        >
          ‚¨áÔ∏è Force Download
        </button>
        <button
          type="button"
          class="download-button secondary-download"
          id="openBtn"
        >
          üé¨ Open Video
        </button>
      </div>

      <div class="status-message" id="downloadStatus" style="display: none;"></div>
    </div>
  </div>

  <div class="error-container" id="error" style="display: none;"></div>

  <div class="platforms-info">
    <h4>üåü Supported Platforms</h4>
    <div class="platforms-grid">
      <span class="platform-tag">TikTok</span>
      <span class="platform-tag">Instagram</span>
      <span class="platform-tag">Twitter/X</span>
      <span class="platform-tag">Facebook</span>
    </div>
  </div>
</div>

<script>
  const API_BASE = window.location.origin + "/media";

  const formElement = document.getElementById("videoForm");
  const loadingElement = document.getElementById("loading");
  const resultElement = document.getElementById("result");
  const errorElement = document.getElementById("error");
  const extractButton = document.getElementById("extractBtn");
  const downloadButton = document.getElementById("downloadBtn");
  const openButton = document.getElementById("openBtn");
  const statusElement = document.getElementById("downloadStatus");

  let currentDownloadUrl = "";
  let currentVideoTitle = "";
  let currentVideoId = "";

  function generateVideoFlowId() {
    const timestamp = Date.now().toString(36);
    const randomStr = Math.random().toString(36).substr(2, 5);
    return `VideoFlow-${timestamp}-${randomStr}`;
  }

  function sanitizeFilename(filename) {
    return filename
      .replace(/[<>:"/\\|?*\x00-\x1f]/g, "")
      .replace(/\s+/g, "_")
      .substring(0, 100);
  }

  function showStatus(message, type = "success") {
    statusElement.textContent = message;
    statusElement.className = `status-message ${type}`;
    statusElement.style.display = "block";

    setTimeout(() => {
      statusElement.style.display = "none";
    }, 8000);
  }

  async function forceDownload(url, filename) {
    try {
      downloadButton.disabled = true;
      downloadButton.innerHTML = "‚è≥ Downloading...";

      try {
        const response = await fetch(url, {
          method: "GET",
          headers: {
            "User-Agent": "VideoFlow-Downloader/1.0",
            Accept: "video/mp4,video/*,*/*;q=0.9",
          },
        });

        if (response.ok) {
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);

          const downloadLink = document.createElement("a");
          downloadLink.href = blobUrl;
          downloadLink.download = filename;
          downloadLink.style.display = "none";

          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
          }, 1000);

          showStatus("‚úÖ Download started! Check your Downloads folder.", "success");
          return true;
        }
      } catch (fetchError) {
        console.log("Blob download failed:", fetchError.message);
      }

      try {
        const proxyResponse = await fetch(`${API_BASE}/api/proxy-download/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            url: url,
            filename: filename,
          }),
        });

        if (proxyResponse.ok) {
          const blob = await proxyResponse.blob();
          const blobUrl = URL.createObjectURL(blob);

          const downloadLink = document.createElement("a");
          downloadLink.href = blobUrl;
          downloadLink.download = filename;
          downloadLink.style.display = "none";

          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
          }, 1000);

          showStatus("‚úÖ Download started via server proxy!", "success");
          return true;
        }
      } catch (proxyError) {
        console.log("Server proxy download failed:", proxyError.message);
      }

      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = url;

      document.body.appendChild(iframe);

      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 3000);

      showStatus('‚ö†Ô∏è Download attempted. If it opened in browser, right-click and "Save As"', "warning");
      return true;

    } catch (error) {
      showStatus(`‚ùå Download failed: ${error.message}`, "error");
      return false;
    } finally {
      downloadButton.disabled = false;
      downloadButton.innerHTML = "‚¨áÔ∏è Force Download";
    }
  }

  function openVideo(url) {
    const newWindow = window.open(url, "_blank");
    if (newWindow) {
      showStatus("üé¨ Video opened in new tab", "success");
    } else {
      showStatus("‚ö†Ô∏è Pop-up blocked. Please allow pop-ups for this site.", "warning");
    }
  }

  formElement.addEventListener("submit", async (e) => {
    e.preventDefault();

    const urlInput = document.getElementById("grabberVideoUrl");
    const url = urlInput.value.trim();
    
    if (!url) {
      showStatus("‚ùå Please enter a valid URL", "error");
      return;
    }

    loadingElement.style.display = "block";
    resultElement.style.display = "none";
    errorElement.style.display = "none";
    extractButton.disabled = true;
    statusElement.style.display = "none";

    try {
      const requestUrl = `${API_BASE}/api/extract/`;
      
      const response = await fetch(requestUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({ url }),
      });

      const data = await response.json();

      if (data.success) {
        currentVideoId = generateVideoFlowId();

        const thumbnailElement = document.getElementById("thumbnail");
        thumbnailElement.src = data.thumbnail || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iOTAiIHZpZXdCb3g9IjAgMCA5MCA5MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjkwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjhGOUZBIiByeD0iMTIiLz4KPHBhdGggZD0iTTM1IDY1TDY1IDQ1TDM1IDI1VjY1WiIgZmlsbD0iIzY2N0VFQSIvPgo8L3N2Zz4=";

        document.getElementById("title").textContent = data.title || "Unknown Video";
        document.getElementById("platform").textContent = data.platform || "Unknown";
        document.getElementById("duration").textContent = data.duration ? `‚è±Ô∏è ${data.duration}s` : "";

        const cleanTitle = sanitizeFilename(data.title || "video");
        const filename = `${currentVideoId}_${cleanTitle}.mp4`;

        document.getElementById("filenameDisplay").textContent = filename;

        currentDownloadUrl = data.download_url;
        currentVideoTitle = filename;

        resultElement.style.display = "block";
        showStatus("‚úÖ Video information extracted successfully!", "success");
      } else {
        throw new Error(data.message || "Failed to extract video information");
      }
    } catch (err) {
      errorElement.textContent = `‚ùå Error: ${err.message}`;
      errorElement.style.display = "block";
      showStatus(`‚ùå ${err.message}`, "error");
    } finally {
      loadingElement.style.display = "none";
      extractButton.disabled = false;
    }
  });

  downloadButton.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (!currentDownloadUrl || !currentVideoTitle) {
      showStatus("‚ùå No video available for download", "error");
      return;
    }

    await forceDownload(currentDownloadUrl, currentVideoTitle);
  });

  openButton.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (!currentDownloadUrl) {
      showStatus("‚ùå No video available to open", "error");
      return;
    }

    openVideo(currentDownloadUrl);
  });

  document.getElementById("thumbnail").addEventListener("error", function () {
    this.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iOTAiIHZpZXdCb3g9IjAgMCA5MCA5MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjkwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjhGOUZBIiByeD0iMTIiLz4KPHBhdGggZD0iTTM1IDY1TDY1IDQ1TDM1IDI1VjY1WiIgZmlsbD0iIzY2N0VFQSIvPgo8L3N2Zz4=";
  });
</script>
{% endblock %}