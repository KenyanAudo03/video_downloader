{% extends 'base.html' %} {% load static %} {% block title %} 
{{ video_metadata.title }} {% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'css/search/search_results.css' %}" />
<link rel="stylesheet" href="{% static 'css/search/url_input.css' %}" />
<div class="split-layout-screen">
  <div class="video-player-section">
    <div class="video-player-container">
      <iframe
        src="https://www.youtube.com/embed/{{ video_id }}?autoplay=1&mute=1&enablejsapi=1"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
        id="sideVideoFrame"
      >
      </iframe>
    </div>
    <div class="current-video-info" id="currentVideoInfo">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 id="currentVideoTitle" style="margin: 0; flex: 1">
          {{ video_metadata.title|truncatechars:65 }}
        </h3>
        <span
          id="currentVideoPublishTime"
          style="font-size: 14px; color: #888; margin-left: 15px; white-space: nowrap;"
        >
          {{ video_metadata.published }}
        </span>
      </div>
    </div>
    <div class="button-group">
      <button class="current-video-download-btn" onclick="downloadCurrentVideo()">
        <svg class="download-icon" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
            clip-rule="evenodd"
          ></path>
        </svg>
        Download Video
      </button>

      <button class="current-video-download-btn" onclick="downloadCurrentAudio()">
        <svg class="download-icon" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
            clip-rule="evenodd"
          ></path>
        </svg>
        Download Audio
      </button>

      <button class="current-video-download-btn" onclick="shareCurrentVideo()">
        <svg class="download-icon" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.49 2.49 0 000-1.39l7.05-4.11A2.5 2.5 0 0018 7.91a2.5 2.5 0 10-2.5-2.5c0 .36.07.7.2 1.02L8.65 10.2a2.5 2.5 0 100 3.6l7.05 4.11c-.13.32-.2.66-.2 1.02a2.5 2.5 0 102.5-2.5z"
          />
        </svg>
        Share
      </button>
    </div>
  </div>
</div>

<!-- Mute indicator -->
<div id="muteIndicator" class="mute-indicator"></div>

<!-- Keyboard hint -->
<div class="keyboard-hint">
  Press <span class="kbd-key">M</span> to mute/unmute
</div>

<!-- YouTube API Script -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  let player;
  let isMuted = true; // Video starts muted
  
  // YouTube API ready callback
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('sideVideoFrame', {
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }
  
  function onPlayerReady(event) {
    // Player is ready, mute toggle will work now
    console.log('YouTube player ready');
  }
  
  function onPlayerStateChange(event) {
    // Handle player state changes if needed
  }

  // Mute/Unmute toggle function
  function toggleMute() {
    if (!player || typeof player.isMuted !== 'function') {
      console.log('Player not ready yet');
      return;
    }

    const muteIndicator = document.getElementById('muteIndicator');
    
    if (player.isMuted()) {
      player.unMute();
      isMuted = false;
      showMuteIndicator('ðŸ”Š Unmuted');
    } else {
      player.mute();
      isMuted = true;
      showMuteIndicator('ðŸ”‡ Muted');
    }
  }

  // Show mute indicator
  function showMuteIndicator(text) {
    const indicator = document.getElementById('muteIndicator');
    indicator.textContent = text;
    indicator.classList.add('show');
    
    setTimeout(() => {
      indicator.classList.remove('show');
    }, 1000);
  }

  // Check if input/textarea is active
  function isInputActive() {
    const activeElement = document.activeElement;
    const inputTypes = ['input', 'textarea', 'select'];
    return inputTypes.includes(activeElement.tagName.toLowerCase()) ||
           activeElement.contentEditable === 'true';
  }

  // Keyboard event listener
  document.addEventListener('keydown', function(event) {
    // Check if 'M' key is pressed and no input is active
    if (event.key.toLowerCase() === 'm' && !isInputActive()) {
      event.preventDefault(); // Prevent default behavior
      toggleMute();
    }
  });

  // Existing share functionality
  function shareCurrentVideo() {
    const videoId = "{{ video_id }}";
    const videoUrl = `${window.location.origin}/${videoId}`;
    const videoTitle = document.getElementById("currentVideoTitle").textContent.trim();
    if (navigator.share) {
      navigator.share({
        title: videoTitle,
        text: `Check out this video: ${videoTitle}`,
        url: videoUrl,
      }).then(() => {
        showNotification("Video shared successfully!");
      }).catch((error) => {
        if (error.name !== "AbortError") {
          fallbackShare(videoUrl, videoTitle);
        }
      });
    } else {
      fallbackShare(videoUrl, videoTitle);
    }
  }

  function fallbackShare(url, title) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(url).then(() => {
        showNotification("Video URL copied to clipboard!");
      }).catch(() => {
        showNotification("Unable to copy URL. Please copy manually.");
      });
    } else {
      const textArea = document.createElement("textarea");
      textArea.value = url;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand("copy");
        showNotification("Video URL copied to clipboard!");
      } catch (err) {
        showNotification("Unable to copy URL. Please copy manually.");
      }

      document.body.removeChild(textArea);
    }
  }

  function showNotification(message) {
    const notification = document.createElement("div");
    notification.className = "share-notification";
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
    `;

    if (!document.querySelector("#share-notification-styles")) {
      const style = document.createElement("style");
      style.id = "share-notification-styles";
      style.textContent = `
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOutRight {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = "slideOutRight 0.3s ease-in";
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }, 3000);
  }
</script>
{% endblock %}